var pageFavDetail=function(a){var b=$(".predate-box"),c={disabled:"disabled",events:{btnCode:"click.action.addCart.refreshBtnCode",imgCode:"click.action.addCart.refreshImgCode"}},d={input:{captcha:'input[name^="captcha"]',img:"img#captcha"}},e={triggerEventFocus:["focus","blur"],triggerEventKeyDown:["keyup","change"],config:{tiptype:2,tipSweep:!1,showAllError:!1,postonce:!0,ajaxPost:!1},action:{refreshCode:function(){f.refCode($(this))}},initConfig:function(b){var c=$.extend(!0,e.config,a.validate.util.tipmsg,b||{});return c},checkCaptcha:function(a){var b=$(this),c={elem:b,curform:b.parents(".modal"),onShow:"请输入验证码",onFocus:"请输入验证码，填写有效的验证码",onCorrect:"",onEmpty:"请输入验证码",onError:"请输入有效的验证码",evType:a.type};e.checkValid(c,"blurValidator",function(){},!1)},checkValid:function(b,c,d){{var f=b.curform;b.elem[0]}switch(focusTxt=b.elem.attr("placeholder"),returnObj=e.initConfig(b),c){case"blurValidator":var g=a.validate.util.getValue.call(f,b.elem),h=!0;if(!b.elem.attr("datatype"))return!1;switch(returnObj.evType){case"focus":focusTxt.length&&b.elem.attr("placeholder","");break;case"blur":"password"!=b.elem.attr("type")||focusTxt.length?b.elem.attr("placeholder",returnObj.onEmpty):b.elem.attr("placeholder",returnObj.onError)}return h=a.validate.util.regcheck.call(f,b.elem.attr("datatype"),g,b.elem,returnObj),h.passed?(a.validate.util.showMessage.call(f,h.info,returnObj.tiptype,{dom:b.elem,type:h.type,sweep:returnObj.tipSweep},"hide"),b.elem.parents("li").removeClass("error"),d(h),!0):(b.elem.parents("li").addClass("error"),a.validate.util.showMessage.call(f,h.info,returnObj.tiptype,{dom:b.elem,type:h.type,sweep:returnObj.tipSweep},"hide"),d(h),!1);default:return!1}},formValid:function(b,c,d){var f,g=b.curform,h=!0,i=e.initConfig(b);return"posting"===g[0].status?!1:i.postonce&&"posted"===g[0].status?!1:(g.find("[datatype]").each(function(){if(c)return!1;if($(this).is(":hidden")||"dataIgnore"===$(this).data("dataIgnore"))return!0;if(!$(this).attr("datatype"))return!1;var b=a.validate.util.getValue.call(g,$(this)),d=$(this);return f=a.validate.util.regcheck.call(g,$(this).attr("datatype"),b,$(this),i),f.passed?void 0:i.showAllError?(h&&(h=!1),!0):(d.focus(),h=!1,!1)}),h?(g[0].status="posting",d(g)):!1)}},f={init:function(){var a=$(this),b={elem:a,shopcart:$('[data-shopcart="true"]'),anItem:a.data("animate"),imageSrc:a.parent().prev().find("[data-original]"),addNum:1,small_image:a.parent().prev().find("[data-original]").attr("src"),product_id:a.data("product_id"),product_name:a.data("product_name"),skuid:a.data("sku_id")};f.add(b)},add:function(b){var d,e,g,h=a.validate.empty(b.skuid),i=a.validate.empty(b.product_id),j=a.validate.empty(b.addNum);if(!i)return a.dialogBlack("无法加入购物车：未知异常"),!1;if(!h)return a.dialogBlack("无法加入购物车：请先选择尺码"),!1;if(!j||b.addNum>1||b.addNum<=0)return a.dialogBlack("无法加入购物车：请勿修改数量"),!1;$("<div />",{"class":"navbar-mask"}).html('<img src="view-src/touch/images/common/loading-big.gif" style="width:20px;" />').appendTo(b.elem.parent());var k={url:"index.php?",data:{m:"flow",act:"addtocart",product_id:b.product_id,size:b.skuid,num:b.addNum,product_name:b.product_name,small_image:b.small_image,back_url:b.back_url},dataType:"json",type:"GET"};k.error=function(){b.elem.next().remove(),a.dialogBlack("网络延时，请刷新页面重试")},k.success=function(h){if(b.elem.next().remove(),d&&(e.curform[0].status="normal",e.elem.removeClass(c.disabled).attr(c.disabled,!1)),0==h.code&&h.add_num>0){d&&g.oncomplete(!1);var i={elem:b.shopcart.children().find(".u-flow-carttime"),startTime:h.clear_time,timeStamp:{day:"",hour:"",min:":",sec:""},action:"remain",callback:!0,callbackFunction:function(){this.add(this.prev().prev()).fadeOut(function(){$(this).html("").prev().prev().html("")})},onDoCallback:!0,onDoComplete:function(a,b){b.complete(!0)}},j=b.imageSrc.length&&b.imageSrc.data("original")?b.imageSrc.data("original"):b.imageSrc.attr("src"),l={elem:b.shopcart.children().children(".i-flow-carticon"),mode:1,width:100,imgSrc:$("<img />",{src:""+j}),animateSpeed:1e3,endCallback:function(c){c.fadeOut(function(){$(this).remove(),b.shopcart.children().children(".u-flow-cartnum").html(h.count).fadeIn("slow").next().fadeIn("slow"),a.showDialog("<p>商品已加入购物车</p>",{width:150,setClass:"ui-modal-popover",position:[{bottom:b.shopcart.outerHeight()+parseInt(b.shopcart.css("bottom"))+10},{left:10}],tipTool:!0,tipsLeft:20,tipsArrow:"black-tips top",autoClose:5e3,overClose:!1,overShow:!1,buttons:!0,type:"defined",buttonsCus:[{name:"立即结算",attribute:!0,mars_sead:"cart-history-tips-count-now_btn"}],buttonsPos:2,buttonsStyle:"btn-purple btn-round",onDoCompleteTo:function(a,b){b.oncomplete(!1),self.location.href="cart.html"}})})}};a.countDown(i),a.animate(l)}else if(111==h.code&&h.url.length>1)d&&g.oncomplete(!1),location.href=h.url;else if(112==h.code)d&&g.oncomplete(!1),a.showDialog(h.msg,{setClass:"ui-modal-doubleBtn",overClose:!1,buttons:!0,type:"defined",buttonsCus:[{name:"取消",attribute:!1},{name:"切换站点",attribute:!0}],onDoComplete:function(a,b){b.oncomplete(!1)},onDoCompleteTo:function(b,c){c.oncomplete(!1),a.showDialog('<h3><img src="view-src/touch/images/common/loading-big.gif" alt="loading" /></h3><p class="c-red">正在切换</p>',{setClass:"ui-white-loading",overClose:!1,closeBtn:!1,width:80,overZindex:1050,autoCall:!0,onAutoComplete:function(b){var c={url:"index.php?",data:{m:"ajax",act:"change_warehouse",wh:h.pwarehouse},dataType:"json",type:"POST"};c.error=function(){b.callback(!1),a.dialogBlack("网络延时，提交订单失败！")},c.success=function(a){b.callback(!1),location.href=a&&null!=a&&void 0!=a&&1==a.code&&a.url?a.url:"index.html"},$.ajax(c)}})}});else if(h.code>0){switch(h.code){case 5003:d?(f.refCode(e.captcha),e.errorText.addClass("error").html("校验出错，请重试")):f.antiBrush(b.elem,function(a,b){k.data.captcha=a.captcha.val(),$.ajax(k,d=!0,e=a,g=b)});break;case 5004:f.refCode(e.captcha),e.errorText.addClass("error").html("校验出错，请重试");break;case 5005:f.refCode(e.captcha),e.errorText.addClass("error").html("校验出错，请重试");break;case 5006:f.refCode(e.captcha),e.errorText.addClass("error").html("校验码输入错误");break;default:d&&g.oncomplete(!1),h.msg.length&&a.showDialog('<p style="text-align:center">'+h.msg+"</p>",{setClass:"ui-modal-singleBtn",overClose:!1,buttons:!0,type:"defined",buttonsCus:[{name:"确定",attribute:!0}],onDoCompleteTo:function(a,c){c.oncomplete(!1),102===h.code&&b.elem.addClass("disabled").empty().attr("data-action",!1).removeAttr("mars_sead")}})}return!1}},$.ajax(k,d=!1,null,null)},antiBrush:function(b,f){var g=a.showDialog('<h1>输入校验码</h1>				<ul class="nav nav-list form form-horizontal">					<li class="control-group control-captcha">						<span><input type="text" name="captcha" size="5" maxlength="4" datatype="*" placeholder="" value=""></span>						<img id="captcha" alt="captcha" src="captcha.html?'+Math.random()+'&type=5" style="width:65px;cursor: pointer;">						<a href="javascript:void(0)" class="btn-refresh">&nbsp;换一张</a>						</li>					<li class="control-text validform-tips"></li>				</ul>',{width:300,setClass:"ui-model-double",top:20,isCenter:!1,setResize:!1,closeBtn:!1,overClose:!1,buttons:!0,type:"defined",onCloseCallBack:!0,buttonsCus:[{name:"取消",attribute:!1},{name:"确定",attribute:!0}],onDoComplete:function(a,c){c.oncomplete(!1),b.next().remove()},onDoCompleteTo:function(a,b){var d={elem:a,curform:a.parents(".modal"),onCorrect:null,captcha:h,errorText:h.parents("li").next(".validform-tips")};e.formValid(d,!1,function(){d.elem.addClass(c.disabled).attr(c.disabled,!0),f(d,b)})}}),h=g.message.find(d.input.captcha);h.off(e.triggerEventFocus[0]).on(e.triggerEventFocus[0],e.checkCaptcha).off(e.triggerEventFocus[1]).on(e.triggerEventFocus[1],e.checkCaptcha),h.off(e.triggerEventKeyDown[0]).on(e.triggerEventKeyDown[0],e.checkCaptcha).off(e.triggerEventKeyDown[1]).on(e.triggerEventKeyDown[1],e.checkCaptcha),g.message.off(c.events.btnCode,"a.btn-refresh").on(c.events.btnCode,"a.btn-refresh",e.action.refreshCode).off(c.events.imgCode,d.input.img).on(c.events.imgCode,d.input.img,e.action.refreshCode)},refCode:function(a){var b={imgCode:a.parents(".modal").find(d.input.img)};b.imgCode.length&&b.imgCode.prev().children(d.input.captcha).length&&(b.imgCode.attr("src","captcha.html?t="+Math.random()+"&type=5"),b.imgCode.prev().children(d.input.captcha).val(""))}},g={events:function(){b.off("click.add.fav.cart",'[data-action="true"]').on("click.add.fav.cart",'[data-action="true"]',f.init)}},h={init:function(){g.events(),$('[data-shopcart="true"]').length&&a.runCartTime()}};return{init:h.init}}(hawk,window);$(function(){pageFavDetail.init()});