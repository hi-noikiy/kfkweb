var pageCartHistoryEffect=function(){var a=$(".u-cart-wrapper"),b={disabled:"disabled",events:{btnCode:"click.action.addCart.refreshBtnCode",imgCode:"click.action.addCart.refreshImgCode"}},c={input:{captcha:'input[name^="captcha"]',img:"img#captcha"}},d={triggerEventFocus:["focus","blur"],triggerEventKeyDown:["keyup","change"],config:{tiptype:2,tipSweep:!1,showAllError:!1,postonce:!0,ajaxPost:!1},action:{refreshCode:function(){f.refCode($(this))}},initConfig:function(a){var b=$.extend(!0,d.config,hawk.validate.util.tipmsg,a||{});return b},checkCaptcha:function(a){var b=$(this),c={elem:b,curform:b.parents(".modal"),onShow:"请输入验证码",onFocus:"请输入验证码，填写有效的验证码",onCorrect:"",onEmpty:"请输入验证码",onError:"请输入有效的验证码",evType:a.type};d.checkValid(c,"blurValidator",function(){},!1)},checkValid:function(a,b,c){{var e=a.curform;a.elem[0]}switch(focusTxt=a.elem.attr("placeholder"),returnObj=d.initConfig(a),b){case"blurValidator":var f=hawk.validate.util.getValue.call(e,a.elem),g=!0;if(!a.elem.attr("datatype"))return!1;switch(returnObj.evType){case"focus":focusTxt.length&&a.elem.attr("placeholder","");break;case"blur":"password"!=a.elem.attr("type")||focusTxt.length?a.elem.attr("placeholder",returnObj.onEmpty):a.elem.attr("placeholder",returnObj.onError)}return g=hawk.validate.util.regcheck.call(e,a.elem.attr("datatype"),f,a.elem,returnObj),g.passed?(hawk.validate.util.showMessage.call(e,g.info,returnObj.tiptype,{dom:a.elem,type:g.type,sweep:returnObj.tipSweep},"hide"),a.elem.parents("li").removeClass("error"),c(g),!0):(a.elem.parents("li").addClass("error"),hawk.validate.util.showMessage.call(e,g.info,returnObj.tiptype,{dom:a.elem,type:g.type,sweep:returnObj.tipSweep},"hide"),c(g),!1);default:return!1}},formValid:function(a,b,c){var e,f=a.curform,g=!0,h=d.initConfig(a);return"posting"===f[0].status?!1:h.postonce&&"posted"===f[0].status?!1:(f.find("[datatype]").each(function(){if(b)return!1;if($(this).is(":hidden")||"dataIgnore"===$(this).data("dataIgnore"))return!0;if(!$(this).attr("datatype"))return!1;var a=hawk.validate.util.getValue.call(f,$(this)),c=$(this);return e=hawk.validate.util.regcheck.call(f,$(this).attr("datatype"),a,$(this),h),e.passed?void 0:h.showAllError?(g&&(g=!1),!0):(c.focus(),g=!1,!1)}),g?(f[0].status="posting",c(f)):!1)}},e={init:function(){_.templateSettings={variable:"data",evaluate:/#%([\s\S]+?)%#/g,interpolate:/#%=([\s\S]+?)%#/g,escape:/#%-([\s\S]+?)%#/g};var b=a,c={elem:b,cartListTpl:_.template($("#cart-history-tpl").html()),imgClassName:"cart-history-photos",imgSelector:b.children().find("[data-original]").attr("class")?"img."+b.children().find("[data-original]").attr("class"):"img.cart-history-photos",imgIndex:b.find("[data-original]").length?b.find("[data-original]").length:0,loading:b.children().eq(0),child:b.children().eq(1)},d={url:"ajaxapi-carthistory.html?"+(new Date).getTime(),data:{},dataType:"json",type:"GET"};d.error=function(){var a={dataList:[]};c.loading.hide(),c.child.append(c.cartListTpl(a)),hawk.dialogBlack("网络延时，请刷新页面重试")},d.success=function(a){if(a&&null!=a&&void 0!=a&&a.status&&a.code)if(c.loading.hide(),a.data&&a.data.length){var b={re:a,imgClassName:c.imgClassName},d={},f={},g=e.itemSizeVal(a.data);if(!g)return;d.url="http://stock.vipshop.com/detail/?is_mobile=1&sids="+encodeURIComponent(g);var h={url:d.url,data:{merchandiseId:"",is_old:a.is_old?a.is_old:""},dataType:"jsonp",jsonpCallback:"handleStock"};h.error=function(){hawk.dialogBlack("网络延时，请刷新页面重试")},h.success=function(a){if(a&&null!=a&&void 0!=a&&a.items&&a.items.length){for(var d=0,e=a.items.length;e>d;d++)f["pid_"+a.items[d].id]=a.items[d].stock?0:1;for(var d=0,e=b.re.data.length;e>d;d++)b.re.data[d].stocksale=f["pid_"+b.re.data[d].size_id]?1:0;c.child.append(c.cartListTpl(b)).show(function(){hawk.lazyloadindex(c.imgSelector,c.imgIndex)})}},$.ajax(h)}else{var b={re:a};c.elem.append(c.cartListTpl(b)).children(".u-cart-history").remove()}else hawk.dialogBlack("网络延时，请刷新页面重试")},$.ajax(d)},itemSizeVal:function(a){for(var b=new Array,c=0;c<a.length;c++)b.push(a[c].size_id);return b=b.join()},message:function(){var a={cookies:hawk.Get("WAP_cart_history"),cart:$('[data-shopcart="true"]').find(".u-flow-cartnum")};(void 0==a.cookies||"undefined"==a.cookies||""==a.cookies)&&a.cart.is(":hidden")&&!a.cart.html()&&hawk.Set("WAP_cart_history",1,"","","/")}},f={init:function(){var a=$(this),b={elem:a,shopcart:$('[data-shopcart="true"]'),parent:a.parents("li"),anItem:a.data("animate"),imageSrc:a.parent().parent().find("img[data-original]"),skuid:a.data("sku_id"),addNum:1,product_id:a.data("product_id"),product_name:a.data("product_name"),small_image:a.data("image"),back_url:encodeURIComponent(location.href)};f.add(b)},add:function(a){var c,d,e,g=hawk.validate.empty(a.skuid),h=hawk.validate.empty(a.product_id),i=hawk.validate.empty(a.addNum);if(!h)return hawk.dialogBlack("无法加入购物车，未知异常"),!1;if(!g)return hawk.dialogBlack("无法加入购物车，请先选择尺码"),!1;if(!i||a.addNum>1||a.addNum<=0)return hawk.dialogBlack("无法加入购物车：请勿修改数量"),!1;$("<div />",{"class":"lmask"}).html('<img src="view-src/touch/images/common/loading-big.gif" style="width:20px;" />').appendTo(a.elem.parent());var j={url:"index.php?",data:{m:"flow",act:"addtocart",product_id:a.product_id,size:a.skuid,num:a.addNum,product_name:a.product_name,small_image:a.small_image,back_url:a.back_url},dataType:"json",type:"GET"};j.error=function(){a.elem.next().remove(),hawk.dialogBlack("网络延时，请刷新页面重试")},j.success=function(g){if(a.elem.next().remove(),c&&(d.curform[0].status="normal",d.elem.removeClass(b.disabled).attr(b.disabled,!1)),0==g.code&&g.add_num>0){c&&e.oncomplete(!1);var h={elem:a.shopcart.children().find(".u-flow-carttime"),startTime:g.clear_time,timeStamp:{day:"",hour:"",min:":",sec:""},action:"remain",callback:!0,callbackFunction:function(){this.add(this.prev().prev()).fadeOut(function(){$(this).html("").prev().prev().html("")})},onDoCallback:!0,onDoComplete:function(a,b){b.complete(!0)}},i=a.imageSrc.length&&a.imageSrc.data("original")?a.imageSrc.data("original"):a.imageSrc.attr("src"),k={elem:a.shopcart.children().children(".i-flow-carticon"),mode:1,width:100,imgSrc:$("<img />",{src:""+i}),animateSpeed:1e3,endCallback:function(b){b.fadeOut(function(){$(this).remove(),a.shopcart.children().children(".u-flow-cartnum").html(g.count).fadeIn("slow").next().fadeIn("slow"),hawk.showDialog("<p>商品已加入购物车</p>",{width:150,setClass:"ui-modal-popover",position:[{bottom:a.shopcart.outerHeight()+parseInt(a.shopcart.css("bottom"))+10},{left:10}],tipTool:!0,tipsLeft:20,tipsArrow:"black-tips top",autoClose:5e3,overClose:!1,overShow:!1,buttons:!0,type:"defined",buttonsCus:[{name:"立即结算",attribute:!0,mars_sead:"cart-history-tips-count-now_btn"}],buttonsPos:2,buttonsStyle:"btn-purple btn-round",onDoCompleteTo:function(a,b){b.oncomplete(!1),self.location.href="cart.html"}})})}};hawk.countDown(h),hawk.animate(k)}else if(111==g.code&&g.url.length>1)c&&e.oncomplete(!1),location.href=g.url;else if(112==g.code)c&&e.oncomplete(!1),hawk.showDialog(g.msg,{setClass:"ui-modal-singleBtn",overClose:!1,buttons:!0,type:"defined",buttonsCus:[{name:"取消",attribute:!1},{name:"切换站点",attribute:!0}],onDoComplete:function(a,b){b.oncomplete(!1)},onDoCompleteTo:function(a,b){b.oncomplete(!1),hawk.showDialog('<h3><img src="view-src/touch/images/common/loading-big.gif" alt="loading" /></h3><p class="c-red">正在切换</p>',{setClass:"ui-white-loading",overClose:!1,closeBtn:!1,width:80,overZindex:1050,autoCall:!0,onAutoComplete:function(a){var b={url:"index.php?",data:{m:"ajax",act:"change_warehouse",wh:g.pwarehouse},dataType:"json",type:"POST"};b.error=function(){a.callback(!1),hawk.dialogBlack("网络延时，提交订单失败！")},b.success=function(b){a.callback(!1),location.href=b&&null!=b&&void 0!=b&&1==b.code&&b.url?b.url:"index.html"},$.ajax(b)}})}});else if(g.code>0){switch(g.code){case 5003:c?(f.refCode(d.captcha),d.errorText.addClass("error").html("校验出错，请重试")):f.antiBrush(a.elem,function(a,b){j.data.captcha=a.captcha.val(),$.ajax(j,c=!0,d=a,e=b)});break;case 5004:f.refCode(d.captcha),d.errorText.addClass("error").html("校验出错，请重试");break;case 5005:f.refCode(d.captcha),d.errorText.addClass("error").html("校验出错，请重试");break;case 5006:f.refCode(d.captcha),d.errorText.addClass("error").html("校验码输入错误");break;default:c&&e.oncomplete(!1),g.msg.length&&hawk.showDialog('<p style="text-align:center">'+g.msg+"</p>",{setClass:"ui-modal-singleBtn",overClose:!1,buttons:!0,type:"defined",buttonsCus:[{name:"确定",attribute:!0}],onDoCompleteTo:function(b,c){c.oncomplete(!1),102===g.code&&a.elem.addClass("disabled").attr("data-action",!1).removeAttr("mars_sead").parents("li").addClass("saleout").children(".u-carted-pic").append('<span class="seldout"></span>')}})}return!1}},$.ajax(j,c=!1,null,null)},antiBrush:function(a,e){var f=hawk.showDialog('<h1>输入校验码</h1>				<ul class="nav nav-list form form-horizontal">					<li class="control-group control-captcha">					<span><input type="text" name="captcha" size="5" maxlength="4" datatype="*" placeholder="" value=""></span>					<img id="captcha" alt="captcha" src="captcha.html?'+Math.random()+'&type=5" style="width:65px;cursor: pointer;">					<a href="javascript:void(0)" class="btn-refresh">&nbsp;换一张</a>					</li>					<li class="control-text validform-tips"></li>		        </ul>',{width:300,setClass:"ui-model-double",top:20,isCenter:!1,setResize:!1,closeBtn:!1,overClose:!1,buttons:!0,type:"defined",onCloseCallBack:!0,buttonsCus:[{name:"取消",attribute:!1},{name:"确定",attribute:!0}],onDoComplete:function(b,c){c.oncomplete(!1),a.next().remove()},onDoCompleteTo:function(a,c){var f={elem:a,curform:a.parents(".modal"),onCorrect:null,captcha:g,errorText:g.parents("li").next(".validform-tips")};d.formValid(f,!1,function(){f.elem.addClass(b.disabled).attr(b.disabled,!0),e(f,c)})}}),g=f.message.find(c.input.captcha);g.off(d.triggerEventFocus[0]).on(d.triggerEventFocus[0],d.checkCaptcha).off(d.triggerEventFocus[1]).on(d.triggerEventFocus[1],d.checkCaptcha),g.off(d.triggerEventKeyDown[0]).on(d.triggerEventKeyDown[0],d.checkCaptcha).off(d.triggerEventKeyDown[1]).on(d.triggerEventKeyDown[1],d.checkCaptcha),f.message.off(b.events.btnCode,"a.btn-refresh").on(b.events.btnCode,"a.btn-refresh",d.action.refreshCode).off(b.events.imgCode,c.input.img).on(b.events.imgCode,c.input.img,d.action.refreshCode)},refCode:function(a){var b={imgCode:a.parents(".modal").find(c.input.img)};b.imgCode.length&&b.imgCode.prev().children(c.input.captcha).length&&(b.imgCode.attr("src","captcha.html?t="+Math.random()+"&type=5"),b.imgCode.prev().children(c.input.captcha).val(""))}},g={events:function(){a.off("click.add.history.cart",'[data-action="addCart"]').on("click.add.history.cart",'[data-action="addCart"]',f.init)}},h={init:function(){g.events(),e.init(),$('[data-shopcart="true"]').length&&hawk.runCartTime(),e.message(),VIP.util.backToTopFix({right:10,bottom:68})}};return{init:h.init}}(window);$(function(){pageCartHistoryEffect.init()});